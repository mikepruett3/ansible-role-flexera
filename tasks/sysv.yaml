---
# SysV Configuration tasks file for ansible-role-flexera

- name: "Check if chkconfig is installed"
  ansible.builtin.shell:
    cmd: command -v chkconfig
  register: result
  ignore_errors: true

- name: "Set Facts for chkconfig (false)"
  ansible.builtin.set_fact:
    chkconfig: false
  when:
    - result.rc != 0

- name: "Set Facts for chkconfig (true)"
  ansible.builtin.set_fact:
    chkconfig: true
  when:
    - result.rc == 0

- name: "Check for existing /etc/init.d directory"
  ansible.builtin.stat:
    path: /etc/init.d
  register: result
  #ignore_errors: true
  when:
    - not chkconfig | bool

- name: "Move existing /etc/init.d entries to temp"
  ansible.builtin.shell:
    cmd: mv /etc/init.d /tmp/init.d.bk
  when:
    - not chkconfig | bool
    - result.stat.exists
    - result.stat.isdir
    - result.failed is false

- name: "Install chkconfig"
  ansible.builtin.dnf:
    name: "initscripts"
    state: present
    disable_gpg_check: yes
  when:
    - not chkconfig | bool

- name: "Move existing /etc/init.d entries back from temp"
  ansible.builtin.shell:
    cmd: mv /tmp/init.d.bk/* /etc/init.d/
  when:
    - not chkconfig | bool

- name: "Register Flexera Services"
  ansible.builtin.shell:
    cmd: chkconfig --add {{ item }}
  with_items:
    - mgsusageag
    - ndtask
    - fnms-docker-monitor
  when:
    - not chkconfig | bool

- name: "Start ndtask and mgsusageag services"
  ansible.builtin.service:
    state: started
    name: "{{ item }}"
  with_items:
    - mgsusageag
    - ndtask
    - fnms-docker-monitor
  when:
      - not chkconfig | bool
